<div class="page-header">
  <h1>üîê Gerenciar Senhas e Usu√°rios</h1>
  <button class="btn btn-primary" (click)="criarNovoUsuario()" *ngIf="authService.isAdmin()">
    + Novo Usu√°rio
  </button>
</div>

<div *ngIf="alertMessage" class="alert alert-{{alertType}}">
  {{ alertMessage }}
</div>

<div *ngIf="!authService.isAdmin()" class="alert alert-danger">
  Apenas administradores podem gerenciar senhas e usu√°rios!
</div>

<div *ngIf="authService.isAdmin() && !loading" class="card">
  <div class="migracao-info">
    <h3>Status da Migra√ß√£o</h3>
    <p><strong>Total de usu√°rios:</strong> {{ usuarios.length }}</p>
    <p><strong>Usu√°rios com senha em texto plano:</strong> {{ usuariosComSenhaPlana.length }}</p>
    <p><strong>Usu√°rios com senha hasheada:</strong> {{ usuarios.length - usuariosComSenhaPlana.length }}</p>
  </div>

  <div *ngIf="usuariosComSenhaPlana.length > 0" class="alert alert-warning">
    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Existem {{ usuariosComSenhaPlana.length }} usu√°rio(s) com senha em texto plano.
    <br><br>
    <strong>Migra√ß√£o Autom√°tica:</strong> As senhas ser√£o migradas automaticamente para hash quando cada usu√°rio fizer login pela primeira vez ap√≥s a implementa√ß√£o do hash.
    <br><br>
    <strong>Como funciona:</strong>
    <ul style="margin: 10px 0; padding-left: 20px;">
      <li>O sistema detecta senhas em texto plano automaticamente</li>
      <li>No primeiro login, a senha √© verificada e migrada para hash</li>
      <li>O processo √© transparente para o usu√°rio</li>
      <li>Voc√™ tamb√©m pode alterar a senha manualmente usando o bot√£o abaixo</li>
    </ul>
  </div>

  <div *ngIf="usuariosComSenhaPlana.length === 0" class="alert alert-success">
    <strong>‚úÖ Tudo certo!</strong> Todas as senhas est√£o hasheadas.
  </div>

  <div *ngIf="usuariosComSenhaPlana.length > 0" class="usuarios-lista">
    <h3>Usu√°rios com Senha em Texto Plano</h3>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Email</th>
          <th>Perfil</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let usuario of usuariosComSenhaPlana">
          <td>{{ usuario.id }}</td>
          <td>{{ usuario.nome }}</td>
          <td>{{ usuario.email }}</td>
          <td>
            <span class="badge" [class.badge-success]="usuario.perfil === 'admin'">
              {{ usuario.perfil === 'admin' ? 'Admin' : 'Funcion√°rio' }}
            </span>
          </td>
          <td>
            <span class="badge badge-warning">Senha em Texto Plano</span>
          </td>
          <td>
            <button class="btn btn-primary btn-small" (click)="abrirModalAlterarSenha(usuario)">
              üîë Alterar Senha
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="usuarios-lista" style="margin-top: 30px;">
    <h3>Todos os Usu√°rios</h3>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Email</th>
          <th>Perfil</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let usuario of usuarios">
          <td>{{ usuario.id }}</td>
          <td>{{ usuario.nome }}</td>
          <td>{{ usuario.email }}</td>
          <td>
            <span class="badge" [class.badge-success]="usuario.perfil === 'admin'">
              {{ usuario.perfil === 'admin' ? 'Admin' : 'Funcion√°rio' }}
            </span>
          </td>
          <td>
            <span class="badge" [class.badge-success]="usuario.ativo" [class.badge-danger]="!usuario.ativo">
              {{ usuario.ativo ? 'Ativo' : 'Inativo' }}
            </span>
          </td>
          <td>
            <button class="btn btn-primary btn-small" (click)="abrirModalAlterarSenha(usuario)">
              üîë Alterar Senha
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div *ngIf="loading" class="loading">
  Carregando usu√°rios...
</div>

<!-- Modal de Alterar Senha -->
<div *ngIf="showModalAlterarSenha" class="modal-overlay" (click)="fecharModalAlterarSenha()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Alterar Senha</h2>
      <button class="btn-close" (click)="fecharModalAlterarSenha()">√ó</button>
    </div>
    <div class="modal-body">
      <div *ngIf="usuarioSelecionado">
        <p><strong>Usu√°rio:</strong> {{ usuarioSelecionado.nome }}</p>
        <p><strong>Email:</strong> {{ usuarioSelecionado.email }}</p>
      </div>
      <div class="form-group" style="margin-top: 20px;">
        <label>Nova Senha *</label>
        <input 
          type="password" 
          [(ngModel)]="novaSenha" 
          class="form-control" 
          placeholder="M√≠nimo 6 caracteres"
          [disabled]="alterandoSenha"
        />
      </div>
      <div class="form-group">
        <label>Confirmar Senha *</label>
        <input 
          type="password" 
          [(ngModel)]="confirmarSenha" 
          class="form-control" 
          placeholder="Digite a senha novamente"
          [disabled]="alterandoSenha"
        />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModalAlterarSenha()" [disabled]="alterandoSenha">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="alterarSenha()" [disabled]="alterandoSenha">
        <span *ngIf="!alterandoSenha">Alterar Senha</span>
        <span *ngIf="alterandoSenha">Alterando...</span>
      </button>
    </div>
  </div>
</div>

